name: Assignment Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Check code style
      id: style
      continue-on-error: true
      run: |
        pylint --disable=C0111,C0103,C0303,C0301 $(git ls-files '*.py') > pylint_results.txt || true
        echo "PYLINT_SCORE=$(tail -n 2 pylint_results.txt | head -n 1 | grep -oP 'Your code has been rated at \K[0-9.]+' || echo '0.0')" >> $GITHUB_ENV
        
    - name: Run unit tests
      if: hashFiles('tests/*') != ''
      id: tests
      continue-on-error: true
      run: |
        pip install pytest
        pytest tests/ --verbose > pytest_results.txt || echo "TESTS_FAILED=true" >> $GITHUB_ENV
        
    - name: Create commit comment
      uses: actions/github-script@v6
      with:
        script: |
          const score = Number(process.env.PYLINT_SCORE);
          let comment = '### Python Code Check Results üìù\n\n';
          
          comment += '#### Style Check\n';
          comment += `Your code style score: ${score}/10.0\n`;
          
          if (score >= 8.0) {
            comment += '‚ú® Great job on code style!\n';
          } else {
            comment += 'üí° There\'s room for style improvements. Check the Actions tab for details.\n';
          }
          
          if (require('fs').existsSync('tests')) {
            comment += '\n#### Unit Tests\n';
            if (process.env.TESTS_FAILED === 'true') {
              comment += '‚ùå Some tests are not passing. Check the Actions tab for details.\n';
            } else {
              comment += '‚úÖ All tests passed! Great work!\n';
            }
          }
          
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: comment
          });