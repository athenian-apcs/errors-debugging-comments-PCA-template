name: Assignment Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Check code style
      id: style
      continue-on-error: true
      run: |
        pylint --disable=C0111,C0103,C0303,C0301 $(git ls-files '*.py') > pylint_results.txt || true
        echo "PYLINT_SCORE=$(tail -n 2 pylint_results.txt | head -n 1 | grep -oP 'Your code has been rated at \K[0-9.]+' || echo '0.0')" >> $GITHUB_ENV
        
    - name: Run unit tests
      if: hashFiles('tests/*') != ''
      id: tests
      continue-on-error: true
      run: |
        pip install pytest
        pytest tests/ --verbose > pytest_results.txt || echo "TESTS_FAILED=true" >> $GITHUB_ENV
        
    - name: Post comment
      run: |
        COMMENT="### Python Code Check Results üìù

        #### Style Check
        Your code style score: ${{ env.PYLINT_SCORE }}/10.0"
        
        if (( $(echo "${{ env.PYLINT_SCORE }} >= 8.0" | bc -l) )); then
          COMMENT="$COMMENT
        ‚ú® Great job on code style!"
        else
          COMMENT="$COMMENT
        üí° There's room for style improvements. Check the Actions tab for details."
        fi
        
        if [ -d "tests" ]; then
          COMMENT="$COMMENT

        #### Unit Tests"
          if [ "${TESTS_FAILED}" == "true" ]; then
            COMMENT="$COMMENT
        ‚ùå Some tests are not passing. Check the Actions tab for details."
          else
            COMMENT="$COMMENT
        ‚úÖ All tests passed! Great work!"
          fi
        fi
        
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ github.token }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
          -d "{\"body\":$(echo "$COMMENT" | jq -Rs .)}"